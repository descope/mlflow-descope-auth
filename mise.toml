[tools]
python = "3.14.2"
uv = "latest"

[env]
_.python.venv = { path = ".venv", create = true }

[tasks.install]
description = "Install dependencies with uv"
run = "uv sync --extra dev"

[tasks.lint]
description = "Run ruff linter"
run = "uv run ruff check mlflow_descope_auth tests examples"

[tasks.format]
description = "Run ruff formatter"
run = "uv run ruff format mlflow_descope_auth tests examples"

[tasks.check]
description = "Run all checks (lint + format + type)"
run = [
    "uv run ruff check mlflow_descope_auth tests examples",
    "uv run ruff format --check mlflow_descope_auth tests examples",
    "uv run mypy mlflow_descope_auth"
]

[tasks.fix]
description = "Auto-fix all issues"
run = [
    "uv run ruff format mlflow_descope_auth tests examples",
    "uv run ruff check --fix mlflow_descope_auth tests examples"
]

[tasks.test]
description = "Run tests with coverage"
run = "uv run pytest --cov=mlflow_descope_auth --cov-report=term-missing"

[tasks.test-quick]
description = "Run tests without coverage"
run = "uv run pytest"

[tasks.clean]
description = "Remove generated files"
run = """
rm -rf build/ dist/ *.egg-info .pytest_cache .ruff_cache .mypy_cache htmlcov/ .coverage .uv_cache
find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
find . -type f -name "*.pyc" -delete
"""

[tasks.pre-commit-install]
description = "Install pre-commit hooks"
run = [
    "uv run pip install pre-commit",
    "uv run pre-commit install"
]

[tasks.pre-commit]
description = "Run pre-commit on all files"
run = "uv run pre-commit run --all-files"

[tasks.dev]
description = "Start MLflow server with Descope authentication"
run = """
if [ -z "$DESCOPE_PROJECT_ID" ]; then
    echo "Error: DESCOPE_PROJECT_ID is required"
    echo "  export DESCOPE_PROJECT_ID='P2XXXXX'"
    exit 1
fi
uv run mlflow server --app-name descope --host 0.0.0.0 --port 5000
"""

[tasks.verify-plugin]
description = "Verify plugin is registered correctly"
run = """
uv run python -c '
import sys
if sys.version_info >= (3, 10):
    from importlib.metadata import entry_points
else:
    from importlib_metadata import entry_points

app_eps = [ep.name for ep in entry_points(group="mlflow.app")]
print("MLflow Plugin Entry Points:")
app_status = "descope" if "descope" in app_eps else "NOT FOUND"
print(f"  App Factory: {app_status}")
'
"""

[tasks.test-all]
description = "Run tests on all Python versions (3.9-3.13) using Hatch"
run = "uv run hatch test --all"

[tasks.test-py39]
description = "Run tests on Python 3.9"
run = "uv run hatch test --python 3.9"

[tasks.test-py310]
description = "Run tests on Python 3.10"
run = "uv run hatch test --python 3.10"

[tasks.test-py311]
description = "Run tests on Python 3.11"
run = "uv run hatch test --python 3.11"

[tasks.test-py312]
description = "Run tests on Python 3.12"
run = "uv run hatch test --python 3.12"

[tasks.test-py313]
description = "Run tests on Python 3.13"
run = "uv run hatch test --python 3.13"

[tasks.ci]
description = "Run CI checks including multi-Python testing"
depends = ["check", "test-all", "verify-plugin"]
