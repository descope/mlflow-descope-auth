version: "3.8"

services:
  mlflow:
    image: python:3.11-slim
    container_name: mlflow-descope
    command: >
      sh -c "
        pip install --no-cache-dir mlflow mlflow-descope-auth &&
        mlflow server --app-name descope-auth --host 0.0.0.0 --port 5000
      "
    environment:
      # Required: Set your Descope Project ID
      - DESCOPE_PROJECT_ID=${DESCOPE_PROJECT_ID:?DESCOPE_PROJECT_ID not set}

      # Optional: Descope configuration
      - DESCOPE_FLOW_ID=${DESCOPE_FLOW_ID:-sign-up-or-in}
      - DESCOPE_REDIRECT_URL=${DESCOPE_REDIRECT_URL:-/}
      - DESCOPE_ADMIN_ROLES=${DESCOPE_ADMIN_ROLES:-admin,mlflow-admin}
      - DESCOPE_DEFAULT_PERMISSION=${DESCOPE_DEFAULT_PERMISSION:-READ}

      # MLflow configuration
      - MLFLOW_BACKEND_STORE_URI=sqlite:////mlflow/mlflow.db
      - MLFLOW_ARTIFACT_ROOT=/mlflow/mlartifacts

    ports:
      - "5000:5000"

    volumes:
      - mlflow-data:/mlflow

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/auth/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    restart: unless-stopped

volumes:
  mlflow-data:
    driver: local
